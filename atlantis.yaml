version: 3

projects:
  - name: my-app-infra
    dir: .
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
      enabled: true
    apply_requirements: [mergeable]
    workflow: default
  - name: my-app-infra-prod
    dir: .
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
      enabled: true
    apply_requirements: [mergeable]
    workflow: prod
  - name: my-app-infra-release
    dir: .
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
      enabled: true
    apply_requirements: [mergeable]
    workflow: default
    branch: /release/
workflows:
  default:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - apply
  prod:
    plan:
      steps:
      - run:
          command: |
            if echo "$HEAD_BRANCH_NAME" | grep -q "^release-"; then
              terraform plan -out $PLANFILE
            fi
          output: strip_refreshing
    apply:
      steps:
      - run: 
          command: |
            if echo "$HEAD_BRANCH_NAME" | grep -q "^release-"; then
              terraform apply $PLANFILE
            fi