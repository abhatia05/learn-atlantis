version: 3

projects:
  - name: my-app-infra
    dir: .
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
      enabled: true
    apply_requirements: [mergeable]
    workflow: default
  - name: my-app-infra-prod
    dir: .
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
      enabled: true
    apply_requirements: [mergeable]
    workflow: prod
  # - name: my-app-infra-release
  #   dir: .
  #   workspace: default
  #   autoplan:
  #     when_modified: ["*.tf", "*.tfvars", "../modules/**/*.tf"]
  #     enabled: true
  #   apply_requirements: [mergeable]
  #   workflow: default
  #   branch: /release/
workflows:
  default:
    plan:
      steps:
        - init
        - plan 
    apply:
      steps:
      - run:
        command: terraform apply -detailed-exitcode
        output: show
  prod:
    plan:
      steps:
      - run:
          command: |
            if echo "$HEAD_BRANCH_NAME" | grep -q "^release-"; then
              terraform plan -out $PLANFILE -detailed-exitcode
            fi
          output: strip_refreshing
      - run:
          command: | 
            if echo "$HEAD_BRANCH_NAME" | grep -vq "^release-"; then
              Echo "Only Running this in release branch"
            fi
          output: show
    apply:
      steps:
      - run: 
          command: |
            if echo "$HEAD_BRANCH_NAME" | grep -q "^release-"; then
              terraform apply $PLANFILE -detailed-exitcode
            fi
      - run:
          command: | 
            if echo "$HEAD_BRANCH_NAME" | grep -vq "^release-"; then
              Echo "Only Running this in release branch"
            fi
          output: show